{% extends "base.html" %}
{% block title %}Novo Scan – {{ test.title }}{% endblock %}
{% block content %}
<div class="row justify-content-center">
  <div class="col-lg-9">
    <div class="card">
      <div class="card-header bg-white fw-semibold">
        <i class="bi bi-upc-scan"></i> Registrar Scan – {{ test.title }}
      </div>
      <div class="card-body">
        <form method="post" enctype="multipart/form-data">
          <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">

          <div class="row g-3 mb-4">
            <div class="col-md-6">
              <label class="form-label fw-semibold" for="respondent_name">Nome do Respondente *</label>
              <input id="respondent_name" type="text" class="form-control" name="respondent_name" autocomplete="name" required>
            </div>
            <div class="col-md-6">
              <label class="form-label fw-semibold" for="observation">Observação / Descrição</label>
              <input id="observation" type="text" class="form-control" name="observation">
            </div>
            <div class="col-12">
              <label class="form-label fw-semibold" for="scan_image">Foto / Scan da Prova <span class="text-muted small">(opcional – PNG, JPG, etc.)</span></label>
              <input id="scan_image" type="file" class="form-control" name="image" accept="image/*,.pdf">
              <div id="scan_preview_wrap" class="mt-3 d-none">
                <div class="small text-muted mb-1">Pré-visualização</div>
                <img id="scan_preview_img" class="img-fluid rounded border d-none" alt="Pré-visualização do scan">
                <iframe id="scan_preview_pdf" class="w-100 rounded border d-none" title="Pré-visualização do PDF" style="height: 420px;"></iframe>
              </div>
              <div class="d-flex flex-wrap gap-2 mt-2">
                <button id="btn_scan_analyze" type="button" class="btn btn-outline-primary btn-sm">
                  <i class="bi bi-magic"></i> Analisar scan
                </button>
                <button id="btn_scan_retry" type="button" class="btn btn-outline-secondary btn-sm d-none">
                  <i class="bi bi-arrow-repeat"></i> Refazer scan
                </button>
              </div>
              <div id="scan_status" class="alert alert-secondary mt-2 mb-0 py-2 d-none" role="status"></div>
              <div class="form-text">Ao inserir um arquivo, o sistema tenta preencher automaticamente nome, observação e respostas. Revise antes de registrar.</div>
            </div>
          </div>

          <h6 class="fw-semibold mb-3">Respostas</h6>
          {% for tq in test.questions %}
          {% set q = tq.question %}
          <div class="mb-4 p-3 border rounded">
            <p class="mb-2 fw-semibold">{{ loop.index }}. {{ q.text }}</p>
            <div class="d-flex flex-wrap gap-3">
              {% for opt in q.get_options() %}
              <div class="form-check">
                <input class="form-check-input" type="radio" name="answer_{{ q.id }}" id="q{{ q.id }}_{{ loop.index }}" value="{{ opt }}">
                <label class="form-check-label" for="q{{ q.id }}_{{ loop.index }}">{{ opt }}</label>
              </div>
              {% endfor %}
            </div>
          </div>
          {% endfor %}

          <div class="d-flex gap-2 mt-3">
            <button type="submit" class="btn btn-primary"><i class="bi bi-check-circle"></i> Registrar</button>
            <a href="{{ url_for('scans_list', tid=test.id) }}" class="btn btn-outline-secondary">Cancelar</a>
          </div>
        </form>
      </div>
    </div>
  </div>
</div>
{% endblock %}
{% block scripts %}
<script>
(() => {
  const fileInput = document.getElementById("scan_image");
  const nameInput = document.getElementById("respondent_name");
  const observationInput = document.getElementById("observation");
  const analyzeBtn = document.getElementById("btn_scan_analyze");
  const retryBtn = document.getElementById("btn_scan_retry");
  const statusBox = document.getElementById("scan_status");
  const previewWrap = document.getElementById("scan_preview_wrap");
  const previewImg = document.getElementById("scan_preview_img");
  const previewPdf = document.getElementById("scan_preview_pdf");
  const csrfTokenInput = document.querySelector('input[name="csrf_token"]');
  const analyzeUrl = "{{ url_for('scan_analyze', tid=test.id) }}";
  let previewUrl = null;

  function setStatus(kind, message) {
    statusBox.classList.remove("d-none", "alert-secondary", "alert-success", "alert-warning", "alert-danger");
    if (kind === "success") statusBox.classList.add("alert-success");
    else if (kind === "partial") statusBox.classList.add("alert-warning");
    else if (kind === "failed") statusBox.classList.add("alert-danger");
    else statusBox.classList.add("alert-secondary");
    statusBox.textContent = message;
  }

  function setLoading(isLoading) {
    analyzeBtn.disabled = isLoading;
    retryBtn.disabled = isLoading;
    if (isLoading) {
      setStatus("info", "Analisando arquivo...");
    }
  }

  function clearPreview() {
    if (previewUrl) {
      URL.revokeObjectURL(previewUrl);
      previewUrl = null;
    }
    previewImg.classList.add("d-none");
    previewPdf.classList.add("d-none");
    previewImg.removeAttribute("src");
    previewPdf.removeAttribute("src");
    previewWrap.classList.add("d-none");
  }

  function updatePreview(file) {
    clearPreview();
    if (!file) return;

    previewUrl = URL.createObjectURL(file);
    previewWrap.classList.remove("d-none");

    const type = (file.type || "").toLowerCase();
    const isPdf = type === "application/pdf" || file.name.toLowerCase().endsWith(".pdf");
    if (isPdf) {
      previewPdf.src = previewUrl;
      previewPdf.classList.remove("d-none");
      return;
    }

    previewImg.src = previewUrl;
    previewImg.classList.remove("d-none");
  }

  function applyAnswers(answers) {
    Object.entries(answers || {}).forEach(([questionId, value]) => {
      const input = document.querySelector(`input[name="answer_${questionId}"][value="${CSS.escape(value)}"]`);
      if (input) input.checked = true;
    });
  }

  async function analyzeCurrentFile() {
    const file = fileInput.files && fileInput.files[0];
    if (!file) {
      setStatus("failed", "Selecione um arquivo antes de analisar.");
      return;
    }

    setLoading(true);
    const formData = new FormData();
    formData.append("image", file);
    if (csrfTokenInput && csrfTokenInput.value) {
      formData.append("csrf_token", csrfTokenInput.value);
    }

    try {
      const resp = await fetch(analyzeUrl, {
        method: "POST",
        body: formData,
      });
      const data = await resp.json();
      if (!resp.ok) {
        setStatus("failed", data.message || "Erro ao analisar o arquivo.");
        retryBtn.classList.remove("d-none");
        return;
      }

      if (data.respondent_name) nameInput.value = data.respondent_name;
      if (data.observation) observationInput.value = data.observation;
      applyAnswers(data.answers);

      const summary = data.summary || {};
      const details = `Respostas detectadas: ${summary.questions_detected || 0}/${summary.questions_total || 0}. ` +
        `Nome: ${summary.name_detected ? "ok" : "não detectado"}. ` +
        `Observação: ${summary.observation_detected ? "ok" : "não detectada"}.`;
      setStatus(data.status || "partial", `${data.message || "Análise concluída."} ${details}`);
      retryBtn.classList.remove("d-none");
    } catch (error) {
      setStatus("failed", "Falha de comunicação durante a análise.");
      retryBtn.classList.remove("d-none");
    } finally {
      setLoading(false);
    }
  }

  fileInput.addEventListener("change", () => {
    retryBtn.classList.add("d-none");
    if (fileInput.files && fileInput.files[0]) {
      updatePreview(fileInput.files[0]);
      analyzeCurrentFile();
    } else {
      clearPreview();
      statusBox.classList.add("d-none");
    }
  });

  analyzeBtn.addEventListener("click", analyzeCurrentFile);
  retryBtn.addEventListener("click", analyzeCurrentFile);
})();
</script>
{% endblock %}
